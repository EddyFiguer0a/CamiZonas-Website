---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Carrito de Compras | CamiZonas">
  <main class="bg-gray-50 min-h-screen pb-32">
    
    <!-- Header -->
    <header class="sticky top-0 bg-white z-40 p-4 border-b border-gray-100 flex justify-between items-center">
      <a href="/" class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center hover:bg-gray-100 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      </a>
      <h1 class="font-black text-lg uppercase italic tracking-tight">Mi Carrito</h1>
      <button id="clear-cart" class="text-xs font-bold text-red-500 hover:text-red-600 transition-colors">
        Vaciar
      </button>
    </header>

    <!-- Estado vac√≠o -->
    <div id="empty-cart" class="hidden flex-col items-center justify-center py-20 px-6 text-center">
      <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
          <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/>
          <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
        </svg>
      </div>
      <h2 class="font-black text-2xl mb-2">Tu carrito est√° vac√≠o</h2>
      <p class="text-gray-500 text-sm mb-8">Agrega productos para empezar tu pedido</p>
      <a href="/" class="bg-black text-white font-bold px-8 py-4 rounded-2xl hover:scale-105 transition-transform">
        Ir a Inicio
      </a>
    </div>

    <!-- Lista de productos -->
    <div id="cart-content" class="hidden">
      <!-- Items del carrito -->
      <section class="p-4 space-y-3" id="cart-items">
        <!-- Los items se insertan aqu√≠ din√°micamente -->
      </section>

      <!-- Resumen -->
      <section class="sticky bottom-20 md:bottom-4 mx-4 bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden">
        <div class="p-6 space-y-4">
          <!-- Subtotal -->
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-600 font-medium">Subtotal</span>
            <span class="font-bold" id="subtotal">Q.0</span>
          </div>

          <!-- Env√≠o -->
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-600 font-medium">Env√≠o</span>
            <span class="text-green-600 font-bold">GRATIS</span>
          </div>

          <!-- Divider -->
          <div class="border-t border-gray-100"></div>

          <!-- Total -->
          <div class="flex justify-between items-center">
            <span class="text-lg font-black">Total</span>
            <span class="text-2xl font-black" id="total">Q.0</span>
          </div>

          <!-- Bot√≥n de WhatsApp -->
          <button id="checkout-btn" class="w-full bg-black text-white h-14 rounded-2xl font-black flex items-center justify-center gap-3 hover:scale-[1.02] active:scale-95 transition-all duration-200 shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="22" height="22" fill="#25D366">
              <path d="M12 2C6.486 2 2 6.486 2 12c0 1.994.574 3.84 1.566 5.396L2 22l4.78-1.538A9.93 9.93 0 0 0 12 22c5.514 0 10-4.486 10-10S17.514 2 12 2zm0 18.182a8.13 8.13 0 0 1-4.144-1.127l-.297-.176-2.834.911.923-2.761-.194-.306A8.126 8.126 0 1 1 12 20.182zm4.47-5.693c-.244-.122-1.444-.713-1.667-.794-.223-.082-.386-.122-.549.122-.163.245-.632.794-.774.958-.142.163-.284.183-.528.061-.244-.122-1.03-.38-1.96-1.21-.724-.646-1.212-1.444-1.354-1.688-.142-.244-.015-.375.107-.497.11-.11.244-.285.366-.427.122-.143.163-.244.244-.407.081-.163.041-.305-.02-.427-.061-.122-.549-1.326-.752-1.815-.198-.476-.399-.412-.549-.42-.142-.007-.305-.009-.467-.009-.163 0-.427.061-.651.305-.223.244-.854.834-.854 2.034s.875 2.36.997 2.523c.122.163 1.72 2.628 4.168 3.684.582.251 1.037.401 1.391.513.584.186 1.115.16 1.535.097.468-.07 1.444-.591 1.647-1.163.203-.571.203-1.061.142-1.163-.061-.102-.223-.163-.467-.285z"/>
            </svg>
            Pedir por WhatsApp
          </button>
        </div>
      </section>
    </div>

  </main>
</Layout>

<script>
  // FUNCIONES PRINCIPALES
  let carrito = [];

  function cargarCarrito() {
    carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    renderizarCarrito();
  }

  function renderizarCarrito() {
    const cartContent = document.getElementById('cart-content');
    const emptyCart = document.getElementById('empty-cart');
    const cartItemsContainer = document.getElementById('cart-items');

    if (carrito.length === 0) {
      cartContent?.classList.add('hidden');
      emptyCart?.classList.remove('hidden');
      emptyCart?.classList.add('flex');
      return;
    }

    cartContent?.classList.remove('hidden');
    emptyCart?.classList.add('hidden');

    // Renderizar items
    if (cartItemsContainer) {
      cartItemsContainer.innerHTML = carrito.map((item, index) => `
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex gap-4">
          <!-- Imagen -->
          <div class="w-24 h-24 bg-gray-100 rounded-xl overflow-hidden flex-shrink-0">
            <img src="${item.imagen}" alt="${item.nombre}" class="w-full h-full object-contain p-2" />
          </div>

          <!-- Info -->
          <div class="flex-1 flex flex-col justify-between">
            <div>
              <h3 class="font-bold text-sm mb-1 line-clamp-2">${item.nombre}</h3>
              <p class="text-xs text-gray-500">
                <span class="font-medium">Versi√≥n:</span> ${item.version} | 
                <span class="font-medium">Talla:</span> ${item.talla || 'No seleccionada'}
              </p>
              ${item.personalizacion?.nombre || item.personalizacion?.numero ? `
                <p class="text-xs text-blue-600 mt-1">
                  Nombre:  ${item.personalizacion.nombre} #${item.personalizacion.numero}
                </p>
              ` : ''}
              ${item.parche ? `
                <p class="text-xs text-purple-600 mt-1">
                   Parche: ${item.parche}
                </p>
              ` : ''}
            </div>

            <div class="flex items-center justify-between mt-2">
              <p class="font-black text-lg">Q.${item.precio}</p>
              <button 
                class="text-red-500 hover:text-red-600 text-xs font-bold"
                onclick="eliminarDelCarrito(${index})"
              >
                Eliminar
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Calcular totales
    calcularTotales();
  }

  function calcularTotales() {
    const subtotal = carrito.reduce((sum, item) => sum + item.precio, 0);
    
    document.getElementById('subtotal').textContent = `Q.${subtotal}`;
    document.getElementById('total').textContent = `Q.${subtotal}`;
  }

  // Hacer funci√≥n global
  window.eliminarDelCarrito = function(index) {
    carrito.splice(index, 1);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    renderizarCarrito();
    
    // Disparar evento para actualizar badge
    window.dispatchEvent(new Event('cartUpdated'));
  };

  // Vaciar carrito
  document.getElementById('clear-cart')?.addEventListener('click', () => {
    if (confirm('¬øSeguro que quieres vaciar el carrito?')) {
      localStorage.removeItem('carrito');
      carrito = [];
      renderizarCarrito();
      window.dispatchEvent(new Event('cartUpdated'));
    }
  });

  // WhatsApp checkout
  document.getElementById('checkout-btn')?.addEventListener('click', () => {
    const telefono = "50232650539"; // Cambia por tu n√∫mero
    
    let mensaje = `Hola üëã, quiero hacer el siguiente pedido:\n\n`;
    
    carrito.forEach((item, index) => {
      mensaje += `${index + 1}. *${item.nombre}*\n`;
      mensaje += `   üíé Versi√≥n: ${item.version}\n`;
      mensaje += `   üìè Talla: ${item.talla || 'Por definir'}\n`;
      
      if (item.personalizacion?.nombre || item.personalizacion?.numero) {
        mensaje += `   ‚ú® Personalizado: ${item.personalizacion.nombre} #${item.personalizacion.numero}\n`;
      }
      
      if (item.parche) {
        mensaje += `   üõ°Ô∏è Parche: ${item.parche}\n`;
      }
      
      mensaje += `   üí∞ Q.${item.precio}\n\n`;
    });

    const total = carrito.reduce((sum, item) => sum + item.precio, 0);
    mensaje += `üí∞ *Total: Q.${total}*`;

    window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, '_blank');
  });

  // Cargar al iniciar
  cargarCarrito();
</script>