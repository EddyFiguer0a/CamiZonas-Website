---
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import RequestJersey from '../components/RequestJersey.astro';
import productos from '../data/productos.json';

const categorias = ['Todas', 'Clubes', 'Selecciones', 'Retro', 'Especiales'];

const conteos = {
  Todas: productos.length,
  Clubes: productos.filter(p => p.categoria === 'Clubes').length,
  Selecciones: productos.filter(p => p.categoria === 'Selecciones').length,
  Retro: productos.filter(p => p.categoria === 'Retro').length,
  Especiales: productos.filter(p => p.categoria === 'Especiales').length,
};
---

<Layout title="Catálogo Completo | CamiZonas">
  <main class="bg-white min-h-screen pb-24 md:pb-12">

    <header class="sticky top-0 bg-white/95 backdrop-blur-md z-40 border-b border-gray-100">
      <div class="p-3 sm:p-4 md:p-6 lg:px-12 flex justify-between items-center">
        <a href="/" class="w-9 h-9 sm:w-10 sm:h-10 bg-gray-50 rounded-full flex items-center justify-center hover:bg-gray-100 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
        </a>
        <h1 class="font-black text-base sm:text-lg md:text-xl uppercase italic tracking-tight">Catálogo</h1>
        <div class="w-9 sm:w-10"></div>
      </div>

      <div class="px-3 sm:px-4 md:px-6 lg:px-12 pb-3">
        <div class="relative group w-full md:max-w-2xl md:mx-auto">
          <input 
            type="text" 
            id="search-catalog"
            placeholder="Buscar tu equipo (ej: Real Madrid)..." 
            class="w-full bg-gray-50 border border-gray-200 rounded-2xl 
                    py-3.5 pl-12 pr-4 
                    text-sm font-medium placeholder:text-gray-400 
                    outline-none transition-all
                    focus:bg-white focus:border-gray-300 focus:ring-2 ring-black/5
                    shadow-sm"
                    style="font-size:16px;"
          />
          <span class="absolute left-4 top-1/2 -translate-y-1/2 
                      text-gray-400 group-focus-within:text-black 
                      transition-colors pointer-events-none">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.3-4.3"/>
            </svg>
          </span>
        </div>
      </div>

      <div class="px-3 sm:px-4 md:px-6 lg:px-12 pb-3 sm:pb-4 flex gap-2 overflow-x-auto no-scrollbar">
        {categorias.map(cat => (
          <button
            class="filter-tab px-4 sm:px-5 py-2 sm:py-2.5 rounded-full text-[10px] sm:text-xs font-bold whitespace-nowrap border border-gray-200 text-gray-600 hover:border-black transition-all duration-200"
            data-categoria={cat}
          >
            {cat}
            <span class="ml-1 opacity-60">({conteos[cat]})</span>
          </button>
        ))}
      </div>
    </header>

    <div class="px-3 sm:px-4 md:px-6 lg:px-12 py-3 sm:py-4 flex justify-between items-center">
      <p class="text-xs sm:text-sm text-gray-500">
        <span id="producto-count" class="font-bold text-black">{productos.length}</span> productos
        <span id="search-info" class="hidden ml-2 text-blue-600 font-medium"></span>
      </p>
    </div>

    <section class="px-3 sm:px-4 md:px-6 lg:px-12 pb-6">
      <div id="productos-grid" class="grid grid-cols-2 gap-3 sm:gap-4 md:grid-cols-3 lg:grid-cols-4 md:gap-5 lg:gap-6">
        {productos.map(prod => {
          const imagenDisponible = (prod.imagenesFan && prod.imagenesFan.length > 0) 
            ? prod.imagenesFan[0] 
            : (prod.imagenesJugador && prod.imagenesJugador.length > 0) 
              ? prod.imagenesJugador[0] 
              : '';
          
          return (
            <div
              class="producto-item"
              data-categoria={prod.categoria}
              data-nombre={prod.nombre.toLowerCase()}
              data-precio={prod.precioFan ?? prod.precioJugador ?? 0}
            >
              <ProductCard
                id={prod.id}
                name={prod.nombre}
                precioFan={prod.precioFan}
                precioJugador={prod.precioJugador}
                imagen={imagenDisponible}
                categoria={prod.categoria}
              />
            </div>
          );
        })}
      </div>

      <div id="empty-state" class="hidden flex-col items-center justify-center py-12 sm:py-16 text-center">
        <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </div>
        <h3 class="font-bold text-base sm:text-lg mb-2">No se encontraron productos</h3>
        <p class="text-xs sm:text-sm text-gray-500 mb-4">Intenta con otros términos</p>
        <button id="clear-search" class="bg-black text-white px-5 sm:px-6 py-2.5 sm:py-3 rounded-xl text-xs sm:text-sm font-bold hover:scale-105 transition-transform">
          Limpiar búsqueda
        </button>
      </div>
    </section>

    <RequestJersey />

  </main>
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
    console.log('✅ Catálogo cargado correctamente');

    let categoriaActual = 'Todas';
    let terminoBusqueda = '';

    const categorias = ['Todas', 'Clubes', 'Selecciones', 'Retro', 'Especiales'];
    const tabs = document.querySelectorAll('.filter-tab');
    const grid = document.getElementById('productos-grid');
    const productoCount = document.getElementById('producto-count');
    const emptyState = document.getElementById('empty-state');
    const searchCatalog = document.getElementById('search-catalog') as HTMLInputElement;
    const searchInfo = document.getElementById('search-info');
    const clearSearch = document.getElementById('clear-search');

    function filtrar() {
      const items = Array.from(grid?.querySelectorAll('.producto-item') || []);
      let visibles: Element[] = [];

      items.forEach(item => {
        const el = item as HTMLElement;
        const cat = el.dataset.categoria || '';
        const name = el.dataset.nombre || '';

        const okCat = categoriaActual === 'Todas' || cat === categoriaActual;
        const okSearch = !terminoBusqueda || name.includes(terminoBusqueda.toLowerCase());

        if (okCat && okSearch) {
          el.style.display = '';
          el.style.animation = 'fadeIn 0.3s ease-out';
          visibles.push(item);
        } else {
          el.style.display = 'none';
        }
      });

      if (productoCount) productoCount.textContent = String(visibles.length);

      if (searchInfo) {
        if (terminoBusqueda) {
          searchInfo.textContent = `para "${terminoBusqueda}"`;
          searchInfo.classList.remove('hidden');
        } else {
          searchInfo.classList.add('hidden');
        }
      }

      if (emptyState && grid) {
        emptyState.classList.toggle('hidden', visibles.length > 0);
        emptyState.classList.toggle('flex', visibles.length === 0);
        grid.classList.toggle('hidden', visibles.length === 0);
      }

      console.log(`✅ Filtrado: ${visibles.length} productos visibles`);
    }

    function actualizarTabs() {
      tabs.forEach(tab => {
        const cat = (tab as HTMLElement).dataset.categoria;
        if (cat === categoriaActual) {
          tab.classList.add('bg-black', 'text-white', 'border-black');
          tab.classList.remove('border-gray-200', 'text-gray-600');
        } else {
          tab.classList.remove('bg-black', 'text-white', 'border-black');
          tab.classList.add('border-gray-200', 'text-gray-600');
        }
      });
      console.log(`✅ Categoría activa: ${categoriaActual}`);
    }

    // Leer parámetros URL
    const params = new URLSearchParams(window.location.search);
    const catURL = params.get('categoria');
    const searchURL = params.get('search');

    if (catURL && categorias.includes(catURL)) {
      categoriaActual = catURL;
      console.log(`✅ Categoría desde URL: ${catURL}`);
    }

    if (searchURL && searchCatalog) {
      terminoBusqueda = searchURL;
      searchCatalog.value = searchURL;
      console.log(`✅ Búsqueda desde URL: ${searchURL}`);
    }

    actualizarTabs();
    filtrar();

    // ✅ Eventos tabs (sin cloneNode)
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        categoriaActual = (tab as HTMLElement).dataset.categoria || 'Todas';
        actualizarTabs();

        const params = new URLSearchParams();
        if (categoriaActual !== 'Todas') params.set('categoria', categoriaActual);
        if (terminoBusqueda) params.set('search', terminoBusqueda);

        history.pushState({}, '', params.toString() ? `/catalogo?${params}` : '/catalogo');
        filtrar();
      });
    });

    // Búsqueda
    let searchTimeout: ReturnType<typeof setTimeout>;

    if (searchCatalog) {
      const newSearchCatalog = searchCatalog.cloneNode(true) as HTMLInputElement;
      searchCatalog.parentNode?.replaceChild(newSearchCatalog, searchCatalog);
      
      const finalSearchCatalog = document.getElementById('search-catalog') as HTMLInputElement;
      if (searchURL) finalSearchCatalog.value = searchURL;

      finalSearchCatalog?.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.trim();
        terminoBusqueda = query;
        
        clearTimeout(searchTimeout);
        filtrar();
        
        if (query.length >= 0) {
          searchTimeout = setTimeout(() => {
            const params = new URLSearchParams();
            if (categoriaActual !== 'Todas') params.set('categoria', categoriaActual);
            if (query) params.set('search', query);
            
            history.pushState({}, '', params.toString() ? `/catalogo?${params}` : '/catalogo');
            console.log(`✅ URL actualizada con búsqueda: ${query}`);
          }, 800);
        }
      });

      finalSearchCatalog?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          clearTimeout(searchTimeout);
          
          const params = new URLSearchParams();
          if (categoriaActual !== 'Todas') params.set('categoria', categoriaActual);
          if (terminoBusqueda) params.set('search', terminoBusqueda);
          
          history.pushState({}, '', params.toString() ? `/catalogo?${params}` : '/catalogo');
        }
      });
    }

    // Clear search
    if (clearSearch) {
      const newClearSearch = clearSearch.cloneNode(true);
      clearSearch.parentNode?.replaceChild(newClearSearch, clearSearch);
      
      document.getElementById('clear-search')?.addEventListener('click', () => {
        terminoBusqueda = '';
        categoriaActual = 'Todas';
        if (searchCatalog) searchCatalog.value = '';
        actualizarTabs();
        history.pushState({}, '', '/catalogo');
        filtrar();
      });
    }
  });
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .producto-item {
    animation: fadeIn 0.3s ease-out;
  }
</style>
</Layout>